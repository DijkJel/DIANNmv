---
title: "DIANNmv"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DIANNmv}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This package can be used to process and analyze mass spec data generated by 
DIANN. It mainly uses the DEP package under the hood, so you can use all DEP
functions once you have created the summarizedExperiment object (check out the
DEP vignette). Also included are some visualization function that I prefer over
the default DEP options. 

Install and load the package from github with the following code (you can
ignore the warnings):

```{r, eval = FALSE}
if (!require('BiocManager', quietly = T)){
  install_packages('BiocManager')
}

if (!require('devtools', quietly = T)){
  install_packages('devtools')
}

install_github('DijkJel/DIANNmv')

```{r setup}
library(DIANNmv)
library(SummarizedExperiment)
library(ggplot2)
```

As input files you will need the protein (report.pg_matrix) and peptide
(report.pr_matrix) DIANN output files. In addition, you need an experimental 
design table. This package comes with these files from a DNA pull down experiment
for demonstration goals.You can inspect the data with 'expDesign',
'report.pg_matrix', and'report.pr_matrix'. 

```{r}

head(report.pg_matrix)
head(report.pr_matrix)
expDesign

```

As you can see in expDesign, there are three conditions with 3 replicates each:
Two variations of a TF binding motif and one negative control that can be used
for both motifs. The names in the 'label' column correspond to the intensity 
columns in report.pg_matrix and should be in the same order
and identically named.

The report.pr_matrix file can be used to add peptide number information and
the median peptide intensity, which is an alternative to iBAQ. 

To get the number of razor/unique peptides per proteinGroup per sample and 
the total number of razor/unique peptides over all samples, and add these to
the report.pg_matrix file:

```{r}
peptides <- get_nPep_prMatrix(report.pr_matrix)
pg_matrix <- add_peptide_numbers(report.pg_matrix, peptides)

```

This adds new columns with the suffix 'npep' to the report.pg_matrix
with the number of identified peptides per sample, and 'n_total' with the 
total number of identified razor/unique peptides per proteinGroup.

```{r}
colnames(pg_matrix)
```

Median peptide intensities can be added after the summarizedExperiment object
is created.

To create this, you can run the prepare_se() function with the report.pg_matrix 
file and associated experimental design. 
You can specify if imputation is done (default: yes, with the minProb method),
filter on missing values (missing_thr), and by default removes potential 
contaminants (coming from the contaminants.txt file from maxquant).
If you provide the report.pr_matrix alongside the report.pg_matrix, peptide
information is automatically added and you can filter on a minimal number
of razor/unique peptides (min_pep, default = 0).


```{r}
se <- prepare_se(report.pg_matrix, expDesign) # without peptide information
se


# Add peptide information and remove all proteinGroups with <2 total 
# razor/unique peptides
se <- prepare_se(report.pg_matrix, expDesign, report.pr_matrix, min_pep = 1)
se

```

The summarizedExperiment object stores a lot of information. As you can see from
the output above, it consists of 5584 proteinGroups (rows) and 9 samples
(columns). Furthermore, the experimental design is stored as 'colData', and
extra information is stored as 'rowData'. The log2 transformed intensities form 
the main assay. Furthermore, if the report.pr_matrix file was provided, 
a second assay is added. For a detailed description of the structure of 
summarizedExperiments, check its documentation. In short, to access different
parts of data:

```{r}
intensities <- assay(se) # log2 protein intensities
peptides <- assay(se, 'peptide_info') # peptide numbers

rd = as.data.frame(rowData(se))
colnames(rd) # Information for each proteinGroup in the se.

cd = as.data.frame(colData(se)) 
cd # The experimental design

```

To get and add the median peptide intensities as additional assay:

```{r}
 mpi <- get_median_intensities_prMatrix(report.pr_matrix)
 se <- add_median_peptide_intensity(se, mpi)
 se # an extra assay 'median_peptide_intensities' is added
 
 mpi <- assay(se, 'median_peptide_intensities')
 
 rd <- as.data.frame(rowData(se))
 head(rd$baseMean_mpi) # shows the average mpi per proteinGroup over all samples
 
```


To perform differential protein expression analysis, you have to run the 
get_DEPresults() function. There are three main types: 'manual' (1 vs 1),
'control' (all vs 1), and 'all' (all vs all). In addition, you can choose the 
p.adj cutoff and log2 fold change cutoffs for significant, and the
method of FDR correction. The DEP default is 'fdrtool', but this has given 
some weird results in the past. Therefore, the default here is 'BH'
(Benjamini-Hochberg), which is also the default that limma uses (which DEP uses
in the background).

get_DEPresults returns a data frame with statistics for the specified tests, 
and can be used for visualization afterwards.

```{r}

# To test a 1 vs 1 comparison
res_man <- get_DEPresults(se, condition1 = 'motif1', condition2 = 'neg_ctrl',
                      type = 'manual')

# To test all conditions vs 1 reference condition
res_ref <- get_DEPresults(se, ref_condition = 'neg_ctrl', type = 'control')

# To test all vs all
res <- get_DEPresults(se, type = 'all')

```


The plotVolcano() function returns volcano plots with the specified significance
cutoffs. If more than 1 comparison is present in your results data frame, a list
of volcano plots will be returned which can be accessed by the '$' operator. 
Check the help page for plotVolcano() (`?plotVolcano`) to see the different 
options for labeling specific points in the volcano.


```{r}

plotVolcano(res_man) # Default volcano plot if one comparison is present.
                    # labels all significant points (can be a bit much).


volcano_list <- plotVolcano(res_ref, label = '') # returns list of volcano plots
                                                 # Don't label anything.
volcano_list$motif1_vs_neg_ctrl # Select which plot you want to see.

# Example of a very ugly volcano plot.
plotVolcano(res_man, pval_cutoff = 0.001, fc_cutoff = 2,
            up_color =  'blue', down_color = 'yellow', ns_color = 'green',
            label = c('SMAD3', 'SMAD4'))




```

If median_peptide_intensities are added to the se, you can also plot an MA-plot,
with abundances on the x-axis, and fold-changes on the y-axis:

```{r}
plot_MA(res_man, label = c('SMAD3', 'SMAD4'))
```

You can also make a Venn diagram showing overlapping significant proteins.
By default, all comparisons present in your results data frame are used, but it
can handle five comparisons maximally. You can specify which comparisons
to include.

```{r}
plot_venn_diagram(res) # all comparisons
plot_venn_diagram(res, comparisons = c('neg_ctrl_vs_motif1', 
                                       'neg_ctrl_vs_motif2')) # only two comp.

plot_venn_diagram(res, comparisons = c('neg_ctrl_vs_motif1', 
                                       'neg_ctrl_vs_motif2'), 
                  colors = c('red', 'blue')) # specify colors used
```


Finally, to get an overview of the number of identified significant proteins
per condition:

```{r}
plot_DEP_barplot(res)
```

You can change the conditions included, order of columns, and labels:

```{r}

# Include only two comparisons and change the order:
plot_DEP_barplot(res, comparisons = c('neg_ctrl_vs_motif2',
                                      'neg_ctrl_vs_motif1'))

# Same as above, but axis labels are changed.
plot_DEP_barplot(res, comparisons = c('neg_ctrl_vs_motif2',
                                      'neg_ctrl_vs_motif1'),
                 names = c('motif2', 'motif1'))

```
